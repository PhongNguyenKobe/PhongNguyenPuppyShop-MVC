@model PhongNguyenPuppy_MVC.Areas.Admin.ViewModels.GuiEmailVM

@{
    Layout = "_LayoutAdmin";
    ViewBag.Title = "Gửi email cho khách hàng";
}

<h2>📧 Gửi email</h2>

@if (TempData["ThongBao"] != null)
{
    <div class="alert alert-success">
        @TempData["ThongBao"]
    </div>
}

<div class="card shadow-sm">
    <div class="card-body">
        <form asp-action="GuiEmail" method="post" id="formGuiEmail">
            <!-- Tiêu đề -->
            <div class="mb-3">
                <label for="TieuDe" class="form-label"><strong>📝 Tiêu đề</strong></label>
                <input type="text" class="form-control" id="TieuDe" name="TieuDe" placeholder="Nhập tiêu đề email..." required />
            </div>

            <!-- Template Selector -->
            <div class="mb-3">
                <label for="TemplateId" class="form-label"><strong>🎨 Chọn mẫu email</strong></label>
                <select class="form-select" id="TemplateId" onchange="loadTemplate()">
                    <option value="">-- Chọn mẫu hoặc tạo tùy chỉnh --</option>
                    <optgroup label="🎉 Khuyến mãi">
                        <option value="promo_christmas">🎄 Khuyến mãi Giáng sinh</option>
                        <option value="promo_newyear">🎆 Khuyến mãi Năm mới</option>
                        <option value="promo_summer">☀️ Khuyến mãi Hè</option>
                        <option value="promo_general">🏷️ Khuyến mãi chung</option>
                    </optgroup>
                    <optgroup label="📢 Thông báo">
                        <option value="product_new">📦 Sản phẩm mới</option>
                        <option value="announcement">📣 Thông báo chung</option>
                        <option value="feedback">⭐ Yêu cầu review</option>
                    </optgroup>
                    <optgroup label="👋 Chào đón">
                        <option value="welcome">🎯 Email chào mừng</option>
                        <option value="thank_you">🙏 Cảm ơn đã mua hàng</option>
                    </optgroup>
                </select>
                <small class="text-muted d-block mt-2">Chọn mẫu sẽ tự động điền nội dung, sau đó bạn có thể chỉnh sửa</small>
            </div>

            <!-- Nội dung với TinyMCE -->
            <div class="mb-3">
                <label for="NoiDung" class="form-label"><strong>✍️ Nội dung email</strong></label>
                <textarea class="form-control" id="NoiDung" name="NoiDung" rows="8"></textarea>
                <small class="text-muted d-block mt-2">💡 Bạn có thể chỉnh sửa nội dung sau khi chọn mẫu</small>
            </div>

            <!-- Preview button -->
            <div class="mb-3">
                <button type="button" class="btn btn-outline-info btn-sm" onclick="xemTruoc()">
                    <i class="bi bi-eye"></i> Xem trước
                </button>
            </div>

            <!-- Email bổ sung -->
            <div class="mb-3">
                <label for="EmailBoSung" class="form-label"><strong>✉️ Email bổ sung (không bắt buộc)</strong></label>
                <input type="text" class="form-control" id="EmailBoSung" name="EmailBoSung"
                       placeholder="Nhập email khác, cách nhau bằng dấu phẩy (vd: user1@gmail.com, user2@gmail.com)" />
                <small class="text-muted d-block mt-2">
                    💡 Nhập các email không có trong hệ thống, cách nhau bằng dấu phẩy (,). Ví dụ: <code>abc@gmail.com, xyz@outlook.com</code>
                </small>
                <div id="emailBoSungList" class="mt-2" style="display: none;">
                    <p class="text-muted mb-2">📧 Email bổ sung sẽ được gửi:</p>
                    <div id="emailBoSungPreview" class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Danh sách email khách hàng -->
            <div class="mb-3">
                <label class="form-label"><strong>📋 Danh sách email khách hàng</strong></label>
                <div class="mb-2">
                    <input type="checkbox" id="chonTatCa" onchange="chonTatCaEmail(this)" />
                    <label for="chonTatCa"><strong>Chọn tất cả (@Model.DanhSachEmail.Count) khách hàng</strong></label>
                </div>

                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f9f9f9;">
                    @if (Model.DanhSachEmail.Count == 0)
                    {
                        <p class="text-muted text-center">Không có khách hàng nào</p>
                    }
                    else
                    {
                        @foreach (var email in Model.DanhSachEmail)
                        {
                            <div class="form-check mb-2">
                                <input class="form-check-input email-checkbox" type="checkbox" name="DanhSachEmail" value="@email" id="email_@email.GetHashCode()" />
                                <label class="form-check-label" for="email_@email.GetHashCode()">
                                    <i class="bi bi-envelope"></i> @email
                                </label>
                            </div>
                        }
                    }
                </div>
                <small class="text-muted d-block mt-2">Đã chọn: <span id="soLuongChon">0</span> khách hàng</small>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" id="btnGuiEmail">
                    <i class="bi bi-send"></i> 📤 Gửi email
                </button>
                <a href="@Url.Action("DanhSach", "KhachHang")" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal Preview Email -->
<div class="modal fade" id="modalXemTruoc" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">👁️ Xem trước email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="background-color: #f5f5f5;">
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background-color: #fff; font-family: Arial, sans-serif;">
                    <h5 id="previewTieuDe" style="color: #1e3a8a; margin-bottom: 15px; font-size: 18px;"></h5>
                    <div id="previewNoiDung" style="line-height: 1.6; color: #333;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- TinyMCE CDN - GPL License -->
<script src="https://cdn.tiny.cloud/1/@Html.Raw(Model.TinyMceApiKey)/tinymce/6/tinymce.min.js"></script>
<script>
        // Khởi tạo TinyMCE
        tinymce.init({
            selector: '#NoiDung',
            language: 'vi',
            height: 400,
            license_key: 'gpl',
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
            ],
            toolbar: [
                'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify',
                'bullist numlist outdent indent | link image media table | removeformat | help | emoticons'
            ],
            toolbar_mode: 'floating',
            content_css: 'default',

            images_upload_url: '@Url.Action("UploadImage", "KhachHang", new { area = "Admin" })',
            automatic_uploads: true,
            file_picker_types: 'image',

            images_upload_handler: function (blobInfo, progress) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.withCredentials = false;
                    xhr.open('POST', '@Url.Action("UploadImage", "KhachHang", new { area = "Admin" })');

                    xhr.upload.onprogress = (e) => {
                        progress(e.loaded / e.total * 100);
                    };

                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            try {
                                const json = JSON.parse(xhr.responseText);
                                if (!json || typeof json.location !== 'string') {
                                    reject('Invalid JSON: ' + xhr.responseText);
                                    return;
                                }
                                resolve(json.location);
                            } catch (e) {
                                reject('Parse error: ' + xhr.responseText);
                            }
                        } else {
                            reject('Image upload failed: ' + xhr.responseText);
                        }
                    };

                    xhr.onerror = () => reject('Image upload failed');
                    xhr.onabort = () => reject('Image upload aborted');

                    const formData = new FormData();
                    formData.append('file', blobInfo.blob(), blobInfo.filename());
                    xhr.send(formData);
                });
            }
        });

        // ===== EMAIL TEMPLATES =====
        const emailTemplates = {
            'promo_christmas': {
                title: '🎄 Khuyến mãi Giáng sinh PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #d63031; font-size: 28px; margin: 0;">🎄 Giáng sinh vui vẻ!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Xin chào quý khách hàng!</p>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; text-align: left; border-radius: 4px;">
          <p style="margin: 0; font-size: 14px; color: #333;">
            Nhân dịp Giáng sinh, <strong>PhongNguyen Puppy</strong> gửi tặng bạn mã giảm giá <strong style="color: #d63031;">SALE10</strong>
          </p>
        </div>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 15px 0;">
          <p style="font-size: 16px; color: #2e7d32; margin: 0;">
            <strong>✨ Giảm 10%</strong> cho tổng giá trị đơn hàng
          </p>
          <p style="font-size: 14px; color: #666; margin: 5px 0;">Áp dụng cho tất cả sản phẩm</p>
        </div>

        <p style="color: #666; font-size: 15px; margin: 15px 0;">
          Hãy nhanh tay đặt hàng để nhận ưu đãi đặc biệt này!
        </p>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #d63031; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          🛍️ MUA NGAY
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Chúc bạn một mùa Giáng sinh an lành và hạnh phúc!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'promo_newyear': {
                title: '🎆 Khuyến mãi Năm mới PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #ff6b6b; font-size: 28px; margin: 0;">🎆 Năm mới, năm mới, ưu đãi mới!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Quý khách hàng thân yêu,</p>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; text-align: left; border-radius: 4px;">
          <p style="margin: 0; font-size: 14px; color: #333;">
            Bắt đầu năm mới với những ưu đãi tuyệt vời từ <strong>PhongNguyen Puppy</strong>
          </p>
        </div>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 15px 0;">
          <p style="font-size: 18px; color: #2e7d32; margin: 0;">
            <strong>🎁 KHUYẾN MẠI ĐẶC BIỆT</strong>
          </p>
          <p style="font-size: 14px; color: #666; margin: 5px 0;">Dành riêng cho quý khách hàng thân thiết</p>
        </div>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #ff6b6b; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          🛍️ ĐẶT HÀNG NGAY
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Chúc quý khách một năm mới an khang, thịnh vượng!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'promo_summer': {
                title: '☀️ Khuyến mãi Hè PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #ff6b35; font-size: 28px; margin: 0;">☀️ Mùa hè sôi động!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Xin chào quý khách hàng!</p>

        <p style="color: #666; font-size: 15px; margin: 15px 0;">
          Trong mùa hè nóng bức này, hãy chọn những sản phẩm chất lượng từ <strong>PhongNguyen Puppy</strong> để chăm sóc thú cưng yêu.
        </p>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; text-align: left; border-radius: 4px;">
          <p style="margin: 0; font-size: 14px; color: #333;">
            <strong>🌞 KHUYẾN MẠI HÈ:</strong> Giảm tới 20% cho tất cả sản phẩm
          </p>
        </div>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #ff6b35; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          🛍️ MUA NGAY
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Chúc bạn một mùa hè vui vẻ cùng thú cưng!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'promo_general': {
                title: '🏷️ Khuyến mãi đặc biệt từ PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #d63031; font-size: 28px; margin: 0;">🏷️ Khuyến mãi đặc biệt!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Xin chào quý khách hàng!</p>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; text-align: left; border-radius: 4px;">
          <p style="margin: 0; font-size: 14px; color: #333;">
            PhongNguyen Puppy có những <strong>ưu đãi hot</strong> dành riêng cho bạn!
          </p>
        </div>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #d63031; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          🛍️ MUA NGAY
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Cảm ơn sự ủng hộ của bạn!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'product_new': {
                title: '📦 Sản phẩm mới từ PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #667eea; font-size: 28px; margin: 0;">📦 Sản phẩm mới đã xuất hiện!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Xin chào bạn!</p>

        <p style="color: #666; font-size: 15px; margin: 15px 0;">
          PhongNguyen Puppy vừa cập nhật những <strong>sản phẩm mới</strong> chất lượng cao cho thú cưng yêu của bạn.
        </p>

        <div style="background: #f0f4ff; padding: 15px; border-radius: 4px; margin: 15px 0;">
          <p style="font-size: 14px; color: #333; margin: 0;">
            ✅ Sản phẩm được chọn lọc kỹ lưỡng<br>
            ✅ Đảm bảo chất lượng tốt nhất<br>
            ✅ Giá cả cạnh tranh
          </p>
        </div>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          👉 XEM NGAY
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Cảm ơn bạn đã tin tưởng PhongNguyen Puppy!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'announcement': {
                title: '📣 Thông báo quan trọng từ PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #0066cc; font-size: 28px; margin: 0;">📣 Thông báo quan trọng</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Quý khách hàng thân yêu,</p>

        <p style="color: #666; font-size: 15px; margin: 15px 0;">
          PhongNguyen Puppy xin thông báo những thay đổi quan trọng nhằm nâng cao chất lượng dịch vụ.
        </p>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #0066cc; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          📖 CHI TIẾT THÊM
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Cảm ơn sự hợp tác của bạn!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'feedback': {
                title: '⭐ Chia sẻ trải nghiệm mua hàng của bạn',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #f39c12; font-size: 28px; margin: 0;">⭐ Giọng nói của bạn rất quan trọng!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Xin chào bạn!</p>

        <p style="color: #666; font-size: 15px; margin: 15px 0;">
          Chúng tôi muốn biết trải nghiệm của bạn khi mua hàng tại PhongNguyen Puppy để có thể cải thiện dịch vụ.
        </p>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #f39c12; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          💬 GỬI NHẬN XÉT
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Cảm ơn bạn đã dành thời gian chia sẻ!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            },
            'thank_you': {
                title: '🙏 Cảm ơn bạn đã mua hàng tại PhongNguyen Puppy',
                content: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px;">
      <div style="background: white; border-radius: 8px; padding: 30px; text-align: center;">
        <h1 style="color: #d63031; font-size: 28px; margin: 0;">🙏 Cảm ơn bạn!</h1>
        <p style="color: #666; font-size: 16px; margin: 15px 0;">Quý khách hàng thân yêu,</p>

        <p style="color: #666; font-size: 15px; margin: 15px 0;">
          Cảm ơn bạn đã tin tưởng và chọn PhongNguyen Puppy. Chúng tôi rất vinh dự được phục vụ bạn!
        </p>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 15px 0;">
          <p style="font-size: 14px; color: #2e7d32; margin: 0;">
            ✅ Đơn hàng của bạn đang được chuẩn bị<br>
            ✅ Bạn sẽ nhận được thông báo cập nhật<br>
            ✅ Liên hệ chúng tôi nếu cần hỗ trợ
          </p>
        </div>

        <a href="https://exacting-glenda-usurpingly.ngrok-free.dev/" style="display: inline-block; background: #2ecc71; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 15px 0;">
          📦 THEO DÕI ĐƠN HÀNG
        </a>

        <p style="color: #999; font-size: 13px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          Chúc bạn và thú cưng luôn khỏe mạnh!<br>
          <strong>PhongNguyen Puppy Shop</strong> 🐶
        </p>
      </div>
    </div>
                `
            }
        };

                // Cập nhật preview khi thay đổi email bổ sung
        document.getElementById('EmailBoSung').addEventListener('input', function() {
            processEmailBoSung();
        });

        // Load template
        function loadTemplate() {
            const templateId = document.getElementById('TemplateId').value;
            if (templateId && emailTemplates[templateId]) {
                const template = emailTemplates[templateId];
                document.getElementById('TieuDe').value = template.title;
                tinymce.get('NoiDung').setContent(template.content);
            }
        }

        // Hàm chọn/bỏ chọn tất cả email
        function chonTatCaEmail(source) {
            const checkboxes = document.querySelectorAll('.email-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateEmailCount();
        }

        // Hàm cập nhật số lượng email được chọn
        function updateEmailCount() {
            const soLuong = document.querySelectorAll('.email-checkbox:checked').length;
            document.getElementById('soLuongChon').textContent = soLuong;
        }

        // Hàm xem trước email
        function xemTruoc() {
            const tieuDe = document.getElementById('TieuDe').value;
            const noiDung = tinymce.get('NoiDung').getContent();

            if (!tieuDe || !noiDung) {
                alert('⚠️ Vui lòng nhập tiêu đề và nội dung trước khi xem trước!');
                return;
            }

            document.getElementById('previewTieuDe').textContent = tieuDe;
            document.getElementById('previewNoiDung').innerHTML = noiDung;

            const modal = new bootstrap.Modal(document.getElementById('modalXemTruoc'));
            modal.show();
        }

        // ===== VALIDATE FORM BEFORE SUBMIT =====
        document.getElementById('formGuiEmail').addEventListener('submit', function (e) {
            const tieuDe = document.getElementById('TieuDe').value.trim();
            const noiDung = tinymce.get('NoiDung').getContent().trim();
            const soEmailChon = document.querySelectorAll('.email-checkbox:checked').length;
            const validEmailBoSung = processEmailBoSung().length;

            // Kiểm tra tiêu đề và nội dung
            if (!tieuDe || !noiDung) {
                e.preventDefault();
                alert('⚠️ Vui lòng:\n1. Nhập tiêu đề\n2. Nhập nội dung email');
                return;
            }

            // Kiểm tra có email để gửi không
            if (soEmailChon === 0 && validEmailBoSung === 0) {
                e.preventDefault();
                alert('⚠️ Vui lòng chọn ít nhất 1 email\n(từ danh sách khách hàng hoặc email bổ sung)');
                return;
            }

            // Hiển thị loading state
            const btn = document.getElementById('btnGuiEmail');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang gửi...';
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateEmailCount();
            document.querySelectorAll('.email-checkbox').forEach(cb => {
                cb.addEventListener('change', updateEmailCount);
            });
        });
</script>
