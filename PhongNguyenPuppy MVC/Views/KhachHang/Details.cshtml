@model PhongNguyenPuppy_MVC.Areas.Admin.ViewModels.HoaDonDetailsViewModel
@{
    ViewData["Title"] = "Chi tiết hóa đơn";

    string GetBadgeClass(string trangThai) => trangThai switch
    {
        "Mới đặt hàng" => "bg-warning text-dark",
        "Đã thanh toán" => "bg-info text-dark",
        "Chờ giao hàng" => "bg-primary",
        "Đã giao hàng" => "bg-success",
        "Khách hàng hủy đơn hàng" => "bg-danger",
        _ => "bg-secondary"
    };
}

<style>
    .product-link {
        color: inherit;
        text-decoration: none;
        transition: color 0.3s ease;
    }

        .product-link:hover {
            color: #0d6efd;
            text-decoration: underline;
        }

    .table-hover tbody tr:hover .product-link {
        color: #0d6efd;
    }
</style>

<div class="container" style="padding-top: 180px; padding-bottom: 50px;">
    <!-- Header -->
    <div class="mb-4">
        <h2>Chi tiết hóa đơn <span class="text-primary">#@Model.MaHd</span></h2>
        <p class="text-muted mb-0">Ngày đặt: @Model.NgayDat.ToString("dd/MM/yyyy HH:mm")</p>
    </div>

    <div class="row mb-4">
        <!-- Thông tin khách hàng -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title border-bottom pb-2 mb-3">Thông tin khách hàng</h5>
                    <p><strong>Họ tên:</strong> @Model.HoTen (@Model.MaKh)</p>
                    <p><strong>Điện thoại:</strong> @Model.DienThoai</p>
                    <p class="mb-0"><strong>Email:</strong> @Model.Email</p>
                </div>
            </div>
        </div>

        <!-- Thông tin đơn hàng -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title border-bottom pb-2 mb-3">Thông tin đơn hàng</h5>
                    <p><strong>Trạng thái:</strong> <span class="badge @GetBadgeClass(Model.TrangThai)">@Model.TrangThai</span></p>
                    <p><strong>Phương thức thanh toán:</strong> @Model.CachThanhToan</p>
                    <p><strong>Phí vận chuyển:</strong> @Model.PhiVanChuyen.ToString("N0") VNĐ</p>
                    @if (!string.IsNullOrEmpty(Model.GhiChu))
                    {
                        <p class="mb-0"><strong>Ghi chú:</strong> <em>@Model.GhiChu</em></p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Thông tin giao dịch (nếu có) -->
    @if (!string.IsNullOrEmpty(Model.TransactionId) || !string.IsNullOrEmpty(Model.PaymentGatewayOrderId))
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title border-bottom pb-2 mb-3">Thông tin giao dịch</h5>
                        <div class="row">
                            @if (!string.IsNullOrEmpty(Model.TransactionId))
                            {
                                <div class="col-md-6">
                                    <p class="mb-2"><small class="text-muted">Mã giao dịch:</small></p>
                                    <p><code class="bg-light p-2 rounded d-inline-block">@Model.TransactionId</code></p>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.PaymentGatewayOrderId))
                            {
                                <div class="col-md-6">
                                    <p class="mb-2"><small class="text-muted">Số hóa đơn (Order ID):</small></p>
                                    <p><code class="bg-light p-2 rounded d-inline-block">@Model.PaymentGatewayOrderId</code></p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Địa chỉ giao hàng -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title border-bottom pb-2 mb-3">Địa chỉ giao hàng</h5>
                    @if (!string.IsNullOrEmpty(Model.ProvinceName) || !string.IsNullOrEmpty(Model.DistrictName) || !string.IsNullOrEmpty(Model.WardName))
                    {
                        @if (!string.IsNullOrEmpty(Model.DiaChi))
                        {
                            <p class="mb-2"><strong>@Model.DiaChi</strong></p>
                        }
                        <p class="text-muted mb-0">
                            @if (!string.IsNullOrEmpty(Model.WardName))
                            {
                                <span>@Model.WardName</span>
                                <span class="mx-2">•</span>
                            }
                            @if (!string.IsNullOrEmpty(Model.DistrictName))
                            {
                                <span>@Model.DistrictName</span>
                                <span class="mx-2">•</span>
                            }
                            @if (!string.IsNullOrEmpty(Model.ProvinceName))
                            {
                                <span>@Model.ProvinceName</span>
                            }
                        </p>
                    }
                    else
                    {
                        <p class="mb-0">@Model.DiaChi</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title border-bottom pb-2 mb-3">Danh sách sản phẩm</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tên hàng hóa</th>
                            <th class="text-end">Đơn giá</th>
                            <th class="text-center">Số lượng</th>
                            <th class="text-end">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            double tamTinh = 0;
                        }
                        @foreach (var item in Model.ChiTietHds)
                        {
                            var thanhTien = (item.DonGia * item.SoLuong) * (1 - item.GiamGia / 100);
                            tamTinh += thanhTien;
                            var productSlug = PhongNguyenPuppy_MVC.Helpers.SeoHelper.GenerateSlug(item.TenHh);
                            <tr>
                                <td>
                                    <a href="@Url.Action("Detail", "HangHoa", new { id = item.MaHh, slug = productSlug })"
                                       class="product-link"
                                       title="Xem chi tiết @item.TenHh">
                                        @item.TenHh
                                    </a>
                                </td>
                                <td class="text-end">@item.DonGia.ToString("N0") VNĐ</td>
                                <td class="text-center">@item.SoLuong</td>
                                <td class="text-end"><strong>@thanhTien.ToString("N0") VNĐ</strong></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tổng kết -->
    <div class="row">
        <div class="col-md-6 ms-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tạm tính:</span>
                        <span>@tamTinh.ToString("N0") VNĐ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-danger">
                        <span>Giảm giá từ mã:</span>
                        <span>-@Model.GiamGia.ToString("N0") VNĐ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span>Phí vận chuyển:</span>
                        <span>+@Model.PhiVanChuyen.ToString("N0") VNĐ</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Tổng cộng:</span>
                        <span class="text-primary">@((tamTinh - Model.GiamGia + Model.PhiVanChuyen).ToString("N0")) VNĐ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>